# 工作流名称：清晰标识功能，包含“版本管理”便于区分
name: Docker Build & Push (Versioned)

# 触发条件：满足以下场景时启动工作流
on:
  # 1. 代码推送到 main 分支时自动触发（日常开发提交触发）
  push:
    branches: ["main"]
  # 2. 支持在 GitHub Actions 页面手动触发（用于测试、紧急部署）
  workflow_dispatch:

# 权限配置：遵循“最小权限原则”，仅授予必需权限
permissions:
  contents: read  # 允许读取仓库代码（检出代码、获取提交信息）
  packages: write # 允许写入 GitHub Packages（推送 Docker 镜像）

# 定义工作流中的任务（Jobs）：按依赖顺序执行
jobs:
  # 任务1：代码测试（确保代码可运行，测试不通过则终止后续构建）
  test:
    runs-on: ubuntu-latest  # 使用 GitHub 托管的最新版 Ubuntu 虚拟机
    steps:
      # 步骤1：检出仓库代码（获取当前推送的完整代码）
      - name: Checkout repository code
        uses: actions/checkout@v4  # 官方 Action，稳定拉取代码，v4 为最新版
      
      # 步骤2：配置 Node.js 环境（匹配项目依赖的 Node 版本）
      - name: Setup Node.js 18
        uses: actions/setup-node@v4  # 官方 Action，自动安装指定 Node 版本
        with:
          node-version: "18"  # 与 Dockerfile 中的“node:18-alpine”版本保持一致
          cache: "npm"        # 缓存 npm 依赖（下次构建无需重新下载，加速流程）
      
      # 步骤3：安装项目依赖（根据 package.json 安装所需依赖）
      - name: Install project dependencies
        run: npm install  # 执行 npm 安装命令，生成 node_modules 目录
      
      # 步骤4：运行测试脚本（验证代码可用性，对应 package.json 中的 test 脚本）
      - name: Run code tests
        run: npm test  # 执行测试命令，若返回非 0 状态码则标记任务失败

  # 任务2：构建并推送 Docker 镜像（依赖 test 任务，仅测试通过后执行）
  build-and-push-docker:
    needs: test  # 明确依赖 test 任务，确保测试通过才进入构建
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出仓库代码（构建镜像需要当前代码中的 Dockerfile、app.js 等文件）
      - name: Checkout repository code
        uses: actions/checkout@v4
      
      # 步骤2：配置 Docker Buildx（Docker 官方推荐工具，优化镜像构建流程）
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3  # 官方 Action，启用多平台构建支持、层缓存
      
      # 步骤3：登录 GitHub Container Registry（GHCR），获取镜像推送权限
      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v3  # 官方 Action，安全处理登录逻辑
        with:
          registry: ghcr.io  # GHCR 的固定域名（不可修改）
          username: ${{ github.actor }}  # 自动获取当前 GitHub 用户名（无需手动填写）
          password: ${{ secrets.GITHUB_TOKEN }}  # GitHub 自动生成的临时密钥，无需手动配置
      
      # 步骤4：构建并推送 Docker 镜像（核心步骤，同时打双标签实现版本管理）
      - name: Build and push Docker image
        uses: docker/build-push-action@v5  # 官方 Action，支持构建+推送一体化
        with:
          context: .  # 构建上下文为当前项目根目录（即 Dockerfile 所在目录）
          push: true  # 启用“推送镜像”功能（不写则仅构建不推送）
          # 关键配置：同时打两个标签，实现版本动态管理
          tags: |
            # 标签1：latest（始终指向最新版本，方便日常使用，如“docker pull 用户名/ci-cd-practice:latest”）
            ghcr.io/${{ github.repository_owner }}/ci-cd-practice:latest
            # 标签2：Git Commit SHA（前7位，唯一标识当前提交，如“ci-cd-practice:8f32c9a”，支持回滚）
            ghcr.io/${{ github.repository_owner }}/ci-cd-practice:${{ github.sha::7 }}
          # 优化配置：启用 Docker 层缓存（避免重复构建相同层，加速后续构建）
          cache-from: type=gha  # 从 GitHub Actions 缓存中读取已构建的镜像层
          cache-to: type=gha,mode=max  # 将当前构建的镜像层写入缓存，最大化复用
